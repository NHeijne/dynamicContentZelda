\documentclass[a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{multicol}
\usepackage{hyperref}
\usepackage[margin=1in]{geometry}
\usepackage{natbib}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{float}
\usepackage{color}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{caption}
\usepackage{subcaption}
\restylefloat{table}

\title{Designing for difficulty based on automatically generated models of player skill}
\author{Arjen Swellengrebel}
\date{\today}

\begin{document}

\maketitle

\begin{multicols*}{2}
\begin{abstract}
This thesis proposes a method by which game designers may elicit specific levels of emotional intensity in players by learning their reaction to situations in the game.
This is done using two subsystems. The first of these determines the level of emotional intensity of the player based on their behaviour in the game.
Secondly, a method for modeling the emotional reaction of a player to game situations is presented.
Finally, a practical example based on \emph{The Legend of Zelda} shows the accuracy of the results of this approach.
\end{abstract}

\section{Introduction}
To enhance the accessibility of a video game, and thereby increase its potential audience, it is desirable to present each player with an experience personalized to them \cite{playercentered}. Perhaps most notably, Valve's \emph{Left 4 Dead} uses a system called the "AI director" which changes the pacing of its combat sequences based on the performance of the players \cite{left4dead}. However, the AI director is limited to removing threats when player tension becomes too high.

The purpose of this thesis is to show how it is possible to modify much of the game's content to achieve a specific player experience. Rather than finding the optimal difficulty, the goal will be to find the effect each game element has on the experience.
\begin{itemize} \item[\textbf{1.}] How can the effect of game elements on the emotional intensity of its players be found? \end{itemize}
To answer this question, it is necessary to know the emotional reaction of a given player to a combination of game elements. Therefore, a secondary goal will be to estimate that reaction without pausing the game to ask the player.
\begin{itemize} \item[\textbf{2.}] How can the emotional state of a player be accurately determined using in-game data? \end{itemize}

To answer these questions, the proposed method has been applied to an example game based on \emph{The Legend of Zelda}. This environment is used to quantify the accuracy of this approach and demonstrates how it can be applied to players' different skill levels. It also shows how the system can be applied generically over different in-game settings, and provides an approach for predicting the effect of unseen elements.

\section{Related Work}
%PCG in games
In \cite{PlayerModeling} \emph{Interactive Storytelling: A Player Modelling Approach}, Thue, Bulitko, Spetch, and Wasylishen present a system which creates a model of a player's preferences using five archetypes (Fighter, Method Actor, Storyteller, Tactician, Power Gamer). This model is then used to choose how the story progresses. Though this system provides a wide range of options, it is limited to its set of player types and to the possible stories designed before play starts.
Here an attempt will be made to do something similar within a game's combat rather than its story. Using preferences for specific challenges in the place of player types, it will be possible to create a more general model, one which is not limited to preconceived storylines and player archetypes but just as adaptable to their preferences.

Hunicke and Chapman's work in \emph{AI for Dynamic Difficulty Adjustment in Games} \cite{DDAinGames} discusses techniques for adjusting a game to fit a player's needs. There are two important differences between their approach and the one outlined herein. Firstly, Hunicke and Chapman modify a predesigned game based on player input and is unable to create games without a basis to modify. Second, their approach tends to make adjustments which increase or decrease the game's objective difficulty. The model proposed here also attempts to create a game where each game element individually is challenging, not just the game as a whole.

In De Araujo and Feij\'o's \emph{Evaluating dynamic difficulty adaptivity in shootâ€™em up games} \cite{shootemup}, several models for dynamic difficulty are discussed. Like Hunicke and Chapman's, these systems model their players, specifically on how diffcult they find the game. These models are then used to adjust the difficulty up or down in a general way, so that all players will experience the same level of challenge. By contrast, the method discussed here models not just players' skill levels, but the impact that any given game element has on a particular player's experience. Instead of increasing the number of enemies on screen, the type of enemy might be changed to one this player finds more enjoyable.

\section{Method}
\begin{figure*}[t]
\centering
\includegraphics[width=0.60\textwidth]{processflowchart}
\captionof{figure}{System flow}
\end{figure*}

The method proposed here consists of two subsystems. The first (hereafter the \emph{estimator}) estimates the amount of stress experienced after an encounter has been completed. This estimate is made using only information specific to the player's behaviour during that encounter. The estimator is constructed before runtime, using labeled data, and is applied equally to every player regardless of skill.

The second subsystem (hereafter the \emph{builder}) predicts the difficulty level of an encounter before it is presented to the player. By necessity, it uses only information which is set when the encounter starts. This model is constructed and updated at runtime, using the results of the estimator as a supervisory signal. The model is created individually for each player.

\subsection{Application}
This method is most directly applicable to brief, self-contained challenges which can be expressed as a collection of obstacles to overcome. Examples include random encounters in a role-playing game, levels or level segments in a linear platform game, and some action games that have the player moving between contrained spaces. In games where individual challenges take a long time to complete, the process of adaptation will likely be too slow to be useful.

During development, the estimator should be trained using a set of in-game occurrences based on supervision by the playtesters. This model can then be released with the game, as it is general to all players. 

During development, tutorials should be designed which introduce each element of design separately (whether they are enemies, obstacles or behaviours). Note that these tutorials do not need to take place entirely at the beginning of the game, although each element should be introduced in a safe environment before being encountered in the game itself.

The tutorials should be used to initialize the builder, which should be specific to each player and should be saved with the user's save file or online profile. This allows construction of appropriate challenges using the builder, while continually improving performance using the estimator.

\subsection{Data} \label{data}
The emotional intensity experienced by a player is measured on a scale from 1 to 10. Intensities of grade 1 through 5 are enjoyable difficulties. A difficulty of 1 means a complete absence of any difficulty, while 5 marks the maximum difficulty which is still enjoyable to the player. Grades of 6 through 10 represent inappropriate difficulties, 6 being just slightly too high, and 10 impossible to succeed at even with extensive practice.

Players were asked to play through a series of rooms containing variable numbers of enemies. In each of these rooms, three possible outcomes are possible: the player  defeats every enemy in the room, leaves the room prematurely, or loses all hearts and is defeated. In each of these cases the game was paused automatically and the player was asked to rate the perceived challenge of the room on the aforementioned scale. A description of the room was then recorded, along with a summary of the player's behaviour in that room and their report of its difficulty.

\subsection{Assumptions}
The system relies on the assumption that the behaviour of a player experiencing some level of emotional intensity is the same regardless of skill. For example, a player who gets hit five times in a room will experience stress as a result of that fact, whether this is a skilled player fighting many enemies or a beginner fighting a single enemy. This assumption allows us to ascertain the stress level of a player without having to stop the game to ask them what it is.

As will be shown in section \ref{results}, this assumption is robust enough to show reasonable accuracy in the data. By including a variable denoting the player's experience with video games, that section will attempt to show exactly how robust the assumption is.

\section{Implementation}
This project is based on the open-source video game \emph{Legend of Zelda: Mystery of Solarus DX} \cite{zeldasolarus}. Areas were randomly generated at runtime using Dormans and Bakkes' technique for generating missions and spaces \cite{missiongrammar}. For these experiments, however, areas were kept fairly linear so as to reduce time spent during user studies. 

\subsection{Game description}
The game area is divided into two sections, a forest and a dungeon. The forest is preceded by a tutorial section consisting of four rooms. The other two areas contain six rooms each. In the forest, players can freely move between areas at any time, while the dungeon has doors which only open when every enemy has been defeated. Additionally, dungeon rooms contain hazards which reduce the player's hit points on contact, while forest rooms do not.

The player starts the game with 24 hit points and a sword which does a single point of damage to every normal enemy. Throughout the experiment, the player can pick up two items that provide different ways of fighting enemies. The first is a glove which lets them pick up and throw rocks and bushes if available, both dealing two points of damage to enemies on a hit). The second is a bag of bombs which can be placed on the ground or thrown at enemies, also dealing two points of damage. 

Enemies are chosen and placed each time the player enters a room. Normal rooms contain four possible types of enemies. These are the \emph{mandible}, a simple walking enemy, the \emph{minillosaur egg}, which remains stationary until the player approaches, the \emph{hardhat beetle} which pushes the player back when hit, and the \emph{knight soldier} which holds a sword which must be avoided. Every type of enemy must be hit three times to be defeated and deals two hit points of damage on a hit. All types also have a small chance of giving the player a heart when they are defeated, which restores 4 hit points.

Two exceptions to this model are the tutorial room and the boss room. The tutorial rooms are simple forest locations which contain a single enemy each. The boss room is located at the end of the dungeon and contains a single \emph{papillosaur king}, a large enemy which shoots weaker versions of the \emph{minillosaur egg} enemy. This enemy must be defeated with three bombs, as it cannot be attacked with the sword.

\begin{figure*}[t]
\centering
\begin{subfigure}[b]{0.45\textwidth}
  \includegraphics[width=\textwidth]{tutorialroom}
  \captionof{figure}{Tutorial room}
\end{subfigure} \hfill
\begin{subfigure}[b]{0.45\textwidth}
  \includegraphics[width=\textwidth]{forestroom}
  \captionof{figure}{Example forest room}
\end{subfigure} \hfill
\begin{subfigure}[b]{0.45\textwidth}
  \includegraphics[width=\textwidth]{dungeonroom}
  \captionof{figure}{Example dungeon room}
\end{subfigure} \hfill
\begin{subfigure}[b]{0.45\textwidth}
  \includegraphics[width=\textwidth]{bossroom}
  \captionof{figure}{Final boss room}
\end{subfigure} \hfill
\end{figure*}

\subsection{Room construction} \label{roomconstruction}
To gather the largest amount of data possible from each room, each player should be presented with challenges they can conceivably overcome. To do this, rooms were created based on informal data gathered early in the development of the project. While this method does not produce results representative of the final product, it does produce setups which will result in somewhat appropriate challenges while still varying the data. To create additional variety in the dataset, eight percent of all encounters were set to an extreme difficulty. In all other rooms, players were presented with intended difficulties of 2 through 6.

In order to start determining the right makeup of a combat encounter for a player, first the reaction of that particular player to every possible enemy in the game must be estimated. Fortunately, this need coincides with the need to train the player in a reasonably safe environment. For these reasons, the player must first fight their way through a series of rooms that each contain one enemy, one room for each type. 

Once every enemy has been encountered once, enough data will be available to make a first estimate of the appropriate difficulty. Subsequent rooms will be constructed to slowly increase the difficulty for this player to a desirable level, starting at the lowest level. Starting at a lower difficulty decreases the risk of frustrating rooms constructed with faulty data, which is a concern at this point because of sparsity. Each of the progressively more difficult rooms will increase the amount of data and thus decrease the margin of error on the formula. This way errors are most likely to occur in rooms with a low difficulty, which reduces the chance of an overshoot creating an impossible challenge for the player.

\section{Results} \label{results} % Talk about experiments separately?
Data was recorded from a total of 16 test subjects. In total, 302 encounters were recorded, each participant completing an average of 18.88 encounters with a standard deviation of 7.191. Five of the test subjects had no experience with action video games, six had some experience but no experience with the \emph{Legend of Zelda} series, and five had previous experience with the game. These groups account for approximately 23.5\%, 43\% and 33\% of the data. Finally, 54\% of all recorded fights were inside the dungeon, and the final boss was seen eleven times in total. The intended difficulty of the encounters presented ranged from 1 to 7.558, with a 3.371 mean and standard deviation of 1.807.

\subsection{Evaluation criteria}
The estimator will be tested using ten-fold cross-validation on the test set. However, since the builder is trained using data from the estimator, errors may propagate even when the accuracy of each system is high. To give an indication of the accuracy of the builder and the overall accuracy of the system, the results of the builder during testing will be compared to the reported difficulties. Since these results were collected during application of the system, they are based on premature iterations of the estimator. Three such iterations will be shown, while the final regrettably must remain untested.

% And what about the experience assumption and its accuracy?

\subsection{Accuracy} \label{accuracy}
\begin{table*}[t]
\centering
\begin{tabular}{|l|cccc|}
\hline Classifier & 
\begin{tabular}{c} Mean\\absolute\\error \end{tabular} & 
\begin{tabular}{c} Root\\mean\\squared\\error \end{tabular} & 
\begin{tabular}{c} Relative\\absolute\\error (\%) \end{tabular} & 
\begin{tabular}{c} Root\\relative\\squared\\error (\%) \end{tabular} \\
\hline
Pace regression & 1.1066 & 1.551 & 71.3851 & 82.9991 \\
SMO regression & 1.0634 & 1.6185 & 68.6005 & 86.6108 \\
M5 rules & 1.0933 & 1.4334 & 70.5283 & 76.7064 \\
Gaussian processes & 0.999 & 1.294 & 64.4455 & 69.2444 \\ 
\hline
\end{tabular}
\captionof{table}{Accuracy of the estimator}
\label{tab:estimator}
\end{table*}

\begin{table*}[t]
\centering
\begin{tabular}{|l|cccc|}
\hline Prior experience & 
\begin{tabular}{c} Mean\\absolute\\error \end{tabular} & 
\begin{tabular}{c} Root\\mean\\squared\\error \end{tabular} & 
\begin{tabular}{c} Relative\\absolute\\error (\%) \end{tabular} & 
\begin{tabular}{c} Root\\relative\\squared\\error (\%) \end{tabular} \\
\hline
Yes & 0.999 & 1.294 & 64.4455 & 69.2444 \\ 
No & 1.0119 & 1.3165 & 65.2775 & 70.4494 \\ 
Increase & 101.29\% & 101.74\% & 101.29\% & 101.74\% \\
\hline
\end{tabular}
\captionof{table}{Evaluation of the experience assumption}
\label{tab:estimator}
\end{table*}

\begin{table*}[t]
\centering
\begin{tabular}{|l|ccc|}
\hline Iteration & 
\begin{tabular}{c} Mean\\absolute\\error \end{tabular} & 
\begin{tabular}{c} Root\\mean\\squared\\error \end{tabular} &
\begin{tabular}{c} Instances \end{tabular} \\
\hline
First & 1.329391354 & 1.673463207 & 72 \\ 
Second & 1.369322858 & 1.705159509 & 108 \\
Third & 1.915672157 & 2.314933135 & 39 \\
Combined & 1.453489773 & 1.81903889 & 219 \\ 
\hline
\end{tabular}
\captionof{table}{Overall accuracy}
\label{tab:overall}
\end{table*}

The figures in this paper were obtained using Weka \cite{weka}.

Table \ref{tab:overall} compares the builder's intent with the user's experience. Note that the builder used Linear Regression in the engine.
Due to sparsity of data and specificity to players, it is difficult to determine the optimal learning algorithm for the builder; however, it is reasonable to assume results could be improved with the use of different learning algorithms. 
Note that for these results, tutorial rooms and boss rooms have been removed from the calculation, since the difficulty of those encounters cannot be predicted during the game.
Finally, note that this is the average accuracy and includes predictions made with varying sparsity of data.

\section{Conclusion}
The results show that a player's stress can be determined after play with an average error of 0.999, just under one point on the scale described in section \ref{data}, which equates to a 19.98\% error on the desirable portion of that scale (1 to 5).

The construction of the builder is more difficult because of the insufficiency of data and the need for a reversible result (that is, a result that can be used as a blueprint with which to build the level, not just a formula for estimating difficulty). Overall however, the tested system provides an average error of roughly 29.07\% of the desirable scale.

To mitigate the effect of these problems, more training can be done at the lower difficulties, this way gaining a bigger body of test data at relatively little risk of the player being overwhelmed, as described in section \ref{roomconstruction}. With robust training, it should be quite possible to create a game which adapts its challenges to specific users' preferences.

\section{Future Work}
As written, the game places enemies in discrete encounters. Planning for emotional intensity will likely be more difficult when enemies are able to move into or out of the space the player is currently in. The previously presented models may be useful as a basis for such a system, but this remains to be tested.

While processing the results discussed in section \ref{accuracy}, an attempt was made to judge the difficulty of the boss fight in advance using data from the builder model. Results proved inconclusive, possibly due to sparsity of data or the specificity of the learned models. More research is necessary to determine if and how the models can be extended to predict and build unseen situations.

Furthermore, the methods proposed here are not specific to the game or the challenges used in this research. In theory, the estimator should not need to be retrained if adding a fifth type of enemy to the game (although it should be apparent that the system will need to be retrained if the game itself is substantially changed). However, this extensibility has not been verified.

\section{Acknowledgements}
Much of the code for this project was provided by Norbert Heijne. His research using the Mystery of Solarus game engine can be found in an upcoming paper. I would also like to express my thanks to him and Sander Bakkes for their support and friendship throughout this project.

\bibliographystyle{plain}
\begin{thebibliography}{9}

\bibitem{PlayerModeling}
D. Thue, V. Bulitko, M. Spetch, E. Wasylishen,
\emph{Interactive Storytelling: A Player Modelling Approach},
The Third Conference on
Artificial Intelligence and Interactive Digital Entertainment (AIIDE),
2007.

\bibitem{DDAinGames}
R. Hunicke, V. Chapman, 
\emph{AI for Dynamic Difficulty Adjustment in Games},
Challenges in Game Artificial Intelligence (AAAI),
2004.

\bibitem{shootemup}
B. De Araujo, B. Feij\'o's,
\emph{Evaluating dynamic difficulty adaptivity in shootâ€™em up games}
SBC - Proceedings of SBGames,
2013.

\bibitem{playercentered}
D. Charles, M. McNeill, M. McAlister, M. Black, A. Moore, K. Stringer, J. Kucklich, and A. Kerr, 
\emph{Player-centered design: Player modeling and
adaptive digital games},
DiGRA, pp. 285â€“298,
2005.

\bibitem{left4dead}
Michael Booth,
\emph{The AI systems of left 4 dead},
Keynote, 5th Artif. Intell. Interactive Digit. Entertain. Conf.,
2009.

\bibitem{zeldasolarus}
Christophe Thiery,
\emph{Legend of Zelda: Mystery of Solarus DX},
\url{solarus-games.org},
2011.

\bibitem{missiongrammar}
Joris Dormans and Sander Bakkes,
\emph{Generating Missions and Spaces for
Adaptable Play Experiences},
{IEEE} Trans. Comput. Intellig. and {AI} in Games, Volume 3, no. 3,
2011.

\bibitem{weka}
Mark Hall, Eibe Frank, Geoffrey Holmes, Bernhard Pfahringer, Peter Reutemann, Ian H. Witten,
\emph{The WEKA Data Mining Software: An Update},
SIGKDD Explorations, Volume 11, Issue 1,
2009.

\end{thebibliography}
\end{multicols*}

\clearpage
\appendix
\section{Data used}
The following is a list of the information recorded after the completion of every room during the experiment.

\begin{multicols}{2}
\subsection{User data}
\begin{itemize}
\item Player's video game experience
\end{itemize}
\subsection{Area}
\begin{itemize}
\item Minillosaur eggs
\item Mandibles
\item Blue hardhats
\item Green knights
\item Presence of papillosaur
\item Health when entering
\item Player has first glove
\item Player has second glove
\item Player has bomb bag
\item Number of pits in the room
\item Number of spikes in the room
\item Bushes in the room
\item Liftable rocks in the room
\item Room location (forest, dungeon)
\item Walkable area of the room
\end{itemize}
\subsection{Behaviour}
\begin{itemize}
\item Room finished, escaped or lost
\item Enemies hit by swords
\item Bombs placed
\item Enemies hit by bombs
\item Enemies hit by thrown items
\item Seconds spent in the room
\item Direction changes
\item Total life lost in this room
\item Clashes with green knight's sword
\item Non-game keys pressed
\item Time spent moving
\item Time spent standing
\item Percentage of time standing still
\item Average number of chasing enemies
\item Minillosaur eggs defeated
\item Mandibles defeated
\item Blue hardhats defeated
\item Green knights defeated
\item Times returned to neutral pose
\item Times stunned in place
\item Times attempted to pick up items
\item Number of times hurt
\item Stairs taken
\item Times spin attack charged
\item Spin attacks used
\item Number of attacks made
\item Number of sword taps on wall
\item Number of heavy items carried
\item Number of heavy items lifted
\item Number of treasures picked up
\item Number of items used
\item Number of falls in pit
\item Return to solid ground
\end{itemize}
\subsection{Difficulty}
\begin{itemize}
\item Estimated difficulty
\item Intended difficulty
\item Reported difficulty
\end{itemize}

\end{multicols}

\end{document}
